graph TB
    classDef ai fill:#2C4A7C,stroke:#2C4A7C,color:#fff
    classDef recorder fill:#1B6B3A,stroke:#1B6B3A,color:#fff,font-weight:bold
    classDef reviewer fill:#8B4513,stroke:#8B4513,color:#fff,font-weight:bold
    classDef data fill:#FFF3CD,stroke:#D4A843,color:#333
    classDef chain fill:#E3F2FD,stroke:#1976D2,color:#333
    classDef external fill:#D5E8D4,stroke:#82B366,color:#333
    classDef human fill:#1B2A4A,stroke:#1B2A4A,color:#fff,font-weight:bold
    classDef mcp fill:#F3E5F5,stroke:#7B1FA2,color:#333

    %% ============ THE TWO MODULES ============
    subgraph SYSTEM["AATP: Two Modules"]
        direction TB

        subgraph MOD1["MODULE 1: RECORDER (ä¼šè®¡å¸ˆ)"]
            direction TB
            M1_DESC["MCP Tool Server\nAny AI can call these tools:"]:::mcp
            
            T1["ðŸ”§ aatp.startSession\n\nInput: purpose, authScope,\ncounterparty (or 'solo'),\nauditLanguage\n\nOutput: sessionId,\ninitiation record"]:::recorder
            
            T2["ðŸ”§ aatp.recordDecision\n\nInput: sessionId,\nauditPointType,\nwhatIDecided,\nwhyIDecidedThis,\nalternativesConsidered,\nstructuredData,\ncounterpartyInput (optional)\n\nOutput: recordId,\nsigned record"]:::recorder
            
            T3["ðŸ”§ aatp.endSession\n\nInput: sessionId,\noutcomeSummary,\ntotalValue\n\nOutput: termination record,\nsession digest"]:::recorder
            
            ENGINE["Internal Engine:\nâ€¢ JSON construction\nâ€¢ SHA-256 hashing (RFC 8785)\nâ€¢ Ed25519 signing\nâ€¢ Hash chain management\nâ€¢ Merkle tree computation\nâ€¢ Storage to configured location"]:::recorder
            
            T1 --> ENGINE
            T2 --> ENGINE
            T3 --> ENGINE
        end

        subgraph MOD2["MODULE 2: REVIEWER (å®¡è®¡å¸ˆ)"]
            direction TB
            M2_DESC["MCP Tool Server\nAudit AI calls these tools:"]:::mcp
            
            T4["ðŸ”§ aatp.verifyChain\n\nInput: agentId,\ntimeRange (optional)\n\nOutput: L1 integrity result\n(chain valid, sigs valid,\nanchors checked)"]:::reviewer
            
            T5["ðŸ”§ aatp.checkCompliance\n\nInput: sessionId,\nauthorizationVC\n\nOutput: L2 compliance result\n(within scope, limits ok,\nnarrativeâ†”data consistent)"]:::reviewer
            
            T6["ðŸ”§ aatp.getSessionForReview\n\nInput: sessionId\n\nOutput: all records in session,\nformatted for AI reading\nwith consistency annotations"]:::reviewer
            
            T7["ðŸ”§ aatp.submitReview\n\nInput: sessionId,\nreasonablenessScore (0-100),\nfindings, recommendations\n\nOutput: stored review record"]:::reviewer
            
            ENGINE2["Internal Engine:\nâ€¢ Hash chain walker\nâ€¢ Signature verifier\nâ€¢ Merkle proof checker\nâ€¢ Authorization VC parser\nâ€¢ Narrativeâ†”structuredData\n  consistency checker\nâ€¢ Review record storage"]:::reviewer
            
            T4 --> ENGINE2
            T5 --> ENGINE2
            T6 --> ENGINE2
            T7 --> ENGINE2
        end
    end

    %% ============ HOW AI USES RECORDER ============
    subgraph USAGE_R["HOW AN AI USES THE RECORDER"]
        direction TB
        AI_DECISION["ðŸ¤– Any AI\n(Claude, GPT, local model)\nmaking a decision"]:::ai
        
        STEP1["1. AI is about to\nmake a decision"]:::data
        STEP2["2. AI calls\naatp.startSession()"]:::data
        STEP3["3. AI makes decision,\nthen calls\naatp.recordDecision()\nwith what+why+data"]:::data
        STEP4["4. If action needed,\nAI executes action,\nthen calls\naatp.recordDecision()\nwith confirmation"]:::data
        STEP5["5. AI calls\naatp.endSession()"]:::data
        
        AI_DECISION --> STEP1 --> STEP2 --> STEP3 --> STEP4 --> STEP5
    end

    %% ============ HOW AI USES REVIEWER ============
    subgraph USAGE_A["HOW AN AUDIT AI USES THE REVIEWER"]
        direction TB
        AI_AUDIT["ðŸ” Audit AI\n(independent service)"]:::ai
        
        STEPA["1. Calls\naatp.verifyChain()\nâ†’ L1 pass/fail"]:::data
        STEPB["2. Calls\naatp.checkCompliance()\nâ†’ L2 findings"]:::data
        STEPC["3. Calls\naatp.getSessionForReview()\nâ†’ reads all records"]:::data
        STEPD["4. AI evaluates\nreasonableness\n(its own judgment)"]:::data
        STEPE["5. Calls\naatp.submitReview()\nâ†’ stores findings"]:::data
        
        AI_AUDIT --> STEPA --> STEPB --> STEPC --> STEPD --> STEPE
    end

    %% ============ STORAGE ============
    subgraph STORAGE["STORAGE (configurable)"]
        direction LR
        LOCAL["Local files\n(SQLite / JSON)"]:::chain
        REMOTE["Remote endpoint\n(API / cloud)"]:::chain
        ANCHOR["Blockchain / TSA\n(Merkle anchors)"]:::external
    end

    %% ============ CONNECTIONS ============
    MOD1 -->|"writes records"| STORAGE
    MOD2 -->|"reads records"| STORAGE
    
    USAGE_R -.->|"calls tools via MCP"| MOD1
    USAGE_A -.->|"calls tools via MCP"| MOD2

    %% ============ PRINCIPAL ============
    PRINCIPAL["ðŸ‘¤ Principal\n(human owner)\n\nReads audit reports\nUpdates authorization\nChooses audit service"]:::human
    
    MOD2 -->|"audit reports"| PRINCIPAL
    PRINCIPAL -->|"authorization VC +\nconfiguration"| MOD1
